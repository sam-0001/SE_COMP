<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bundle Details | ExamSuccess</title>
    <link rel="stylesheet" href="../static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Extra styles for the download buttons */
        .download-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f1f2f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-decoration: none;
            color: #2d3436;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .download-btn:hover {
            background-color: #e1f5fe;
            border-color: #6c5ce7;
            color: #6c5ce7;
        }
        .locked-file {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #eee;
        }
        .icon { font-size: 1.2rem; }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <nav>
                <div class="logo"><a href="index.html">‚ö° ExamSuccess</a></div>
            </nav>
        </div>
    </header>

    <div class="container" style="margin-top: 50px; max-width: 800px;">
        
        <div class="warning-box">
            <span>üîí</span>
            <div>
                <strong>Security Alert:</strong> Files are viewable for 2 hours post-purchase. 
                Do not share your link or you will be blocked.
            </div>
        </div>

        <h1 id="bundle-name" style="font-size: 2.5rem; margin-bottom: 10px;">Loading...</h1>
        <p style="color: #636e72; margin-bottom: 30px;">
            Get instant access to the most comprehensive notes available. 
            Once purchased, the download buttons will appear below.
        </p>

        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow);">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <span style="font-size: 1.1rem; font-weight: bold;">Included Files:</span>
                <span class="card-price" id="bundle-price">...</span>
            </div>

            <div id="file-container">
                </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div id="action-area">
                <button id="pay-btn" class="btn btn-primary full-width" style="padding: 18px; font-size: 1.1rem;">
                    üîí Unlock Notes Now
                </button>
                <p style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #b2bec3;">
                    Secured by Razorpay ‚Ä¢ 100% Safe Payment
                </p>
            </div>
        </div>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    const params = new URLSearchParams(window.location.search);
    const bundleId = params.get('id') || 'ds';

    const fileContainer = document.getElementById('file-container');
    let loadedFiles = [];
    let secureToken = null; // Stores the JWT after payment

    // 1. Load Files (Locked State)
    async function loadFiles() {
        try {
            const res = await fetch(`/api/files/${bundleId}`);
            const data = await res.json();
            loadedFiles = data.files || [];
            
            // Set Titles (Optional: Fetch real names from backend)
            document.getElementById('bundle-name').textContent = "Secure Notes Bundle";
            
            renderLockedState();
        } catch (e) { console.error(e); }
    }

    // 2. Render Locked
    function renderLockedState() {
        fileContainer.innerHTML = '';
        loadedFiles.forEach(file => {
            fileContainer.innerHTML += `
                <div class="download-btn locked-file">
                    <span>üìÑ ${file.name}</span>
                    <span style="font-size:0.8rem">üîí Locked</span>
                </div>`;
        });
    }

    // 3. Render Unlocked (With Token)
    function renderUnlockedState() {
        fileContainer.innerHTML = '';
        loadedFiles.forEach(file => {
            // Append the token to the download URL
            const secureLink = `/download/${file.id}?token=${secureToken}`;
            
            fileContainer.innerHTML += `
                <a href="${secureLink}" class="download-btn">
                    <span>üìÑ ${file.name}</span>
                    <span class="icon">‚¨áÔ∏è</span>
                </a>`;
        });

        document.getElementById('action-area').innerHTML = `
            <div style="text-align:center; color: #27ae60; font-weight:bold; padding:10px;">
                ‚úÖ Payment Successful! Access valid for 2 hours.
            </div>`;
    }

    // 4. RAZORPAY PAYMENT LOGIC
    document.getElementById('pay-btn').addEventListener('click', async () => {
        // A. Ask Backend to Create Order
        const res = await fetch('/create_order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ bundle_id: bundleId })
        });
        const orderData = await res.json();

        if (orderData.error) { alert(orderData.error); return; }

        // B. Open Razorpay Options
        const options = {
            "key": orderData.key_id,
            "amount": orderData.amount,
            "currency": "INR",
            "name": "ExamSuccess Notes",
            "description": "Premium Notes Bundle",
            "order_id": orderData.order_id,
            "handler": async function (response) {
                // C. Verify Payment on Backend
                const verifyRes = await fetch('/verify_payment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature,
                        bundle_id: bundleId
                    })
                });

                const verifyData = await verifyRes.json();
                
                if (verifyData.status === 'success') {
                    // D. Save Token & Unlock
                    secureToken = verifyData.token;
                    renderUnlockedState();
                } else {
                    alert("Payment verification failed!");
                }
            },
            "theme": { "color": "#6c5ce7" }
        };

        const rzp1 = new Razorpay(options);
        rzp1.open();
    });

    loadFiles();
</script>

</body>
</html>
